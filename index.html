<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theremin JavaScript Avanzado</title>
    
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            overflow: hidden; 
            transition: background-color 0.5s;
            margin: 0;
            padding: 0;
        }
        h1 { margin-bottom: 10px; }
        #status { font-size: 1rem; margin-bottom: 15px; color: #aaa; }
        
        button {
            padding: 15px 30px;
            font-size: 1.2rem;
            background-color: #00d2ff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 15px #00d2ff;
            transition: transform 0.1s, background-color 0.3s;
            margin-bottom: 20px;
        }
        button:active { transform: scale(0.95); }
        .stop-color { background-color: #ff3838; box-shadow: 0 0 15px #ff3838; }

        .data-display {
            display: flex;
            justify-content: space-around;
            width: 90%;
            max-width: 400px;
            margin-top: 10px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            font-size: 0.9rem;
        }
        .data-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #visualizer {
            display: block;
            background-color: rgba(0, 0, 0, 0.5);
            margin-top: 15px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>

    <h1> Theremin Web Avanzado</h1>
    <a href="index0.html">
    <button style="margin-bottom: 5px; background-color: #f7a83d; box-shadow: 0 0 10px #f7a83d;">
        Ir a Versi贸n V2 (Sencilla)
    </button>
</a>
    <p id="status">Pulsa el bot贸n para empezar a hacer m煤sica. Aseg煤rate de estar en HTTPS.</p>
    
    <button id="toggleBtn">ACTIVAR SONIDO Y SENSORES</button>

    <canvas id="visualizer" width="300" height="100"></canvas>

    <div class="data-display">
        <div class="data-item">
            Frecuencia (Beta): <span id="freqVal">0</span> Hz
        </div>
        <div class="data-item">
            Volumen (Gamma): <span id="volVal">0</span> %
        </div>
        <div class="data-item">
            Timbre (Alpha): <span id="timbreVal">SINE</span>
        </div>
    </div>
    
    <script>
        // --- Variables Globales ---
        let audioCtx = null;
        let oscillator = null;
        let gainNode = null;
        let analyser = null;
        let dataArray = null;
        let wakeLock = null; // Para Wake Lock API
        let isPlaying = false;
        const WAVEFORMS = ['sine', 'square', 'sawtooth', 'triangle'];

        const toggleBtn = document.getElementById('toggleBtn');
        const statusText = document.getElementById('status');
        const freqDisp = document.getElementById('freqVal');
        const volDisp = document.getElementById('volVal');
        const timbreDisp = document.getElementById('timbreVal');
        const canvas = document.getElementById('visualizer');
        const canvasCtx = canvas.getContext('2d');

        // --- 1. Audio Setup ---
        function initAudio() {
            if (audioCtx) return; 

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            // 1. Oscilador (Generador de Tono)
            oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            
            // 2. Ganancia (Volumen)
            gainNode = audioCtx.createGain();
            
            // 3. Analizador (Visualizaci贸n de Espectro)
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            
            // Conexi贸n: Oscilador -> Ganancia -> Analizador -> Altavoces
            oscillator.connect(gainNode);
            gainNode.connect(analyser);
            analyser.connect(audioCtx.destination); 

            gainNode.gain.value = 0; // Inicia en silencio
            oscillator.start();

            // Iniciar el bucle de visualizaci贸n
            drawVisualizer();
        }

        // --- 2. Sensor Handler (La parte "Interesante") ---
        function handleOrientation(event) {
            if (!isPlaying) return;

            // --- BETA: Frecuencia (Logar铆tmico) ---
            let beta = event.beta; 
            if (beta < 0) beta = 0; 
            if (beta > 90) beta = 90;

            const tilt_ratio = beta / 90; // Rango 0 a 1
            const MIN_FREQ = 100;
            const MAX_FREQ = 2000; 

            // F贸rmula exponencial para mapeo musical
            const frequency = MIN_FREQ * Math.pow((MAX_FREQ / MIN_FREQ), tilt_ratio); 
            
            // --- GAMMA: Volumen (Lineal) ---
            let gamma = event.gamma;
            let volume = (gamma + 45) / 90; 
            
            if (volume < 0) volume = 0;
            if (volume > 1) volume = 1;

            // --- ALPHA: Timbre/Waveform (Discreto) ---
            let alpha = event.alpha;
            // Divide los 360 grados en 4 zonas de 90 grados
            const waveIndex = Math.floor(alpha / 90); 
            const newWave = WAVEFORMS[waveIndex];

            // APLICAR CAMBIOS
            oscillator.frequency.setTargetAtTime(frequency, audioCtx.currentTime, 0.05);
            gainNode.gain.setTargetAtTime(volume, audioCtx.currentTime, 0.05);
            
            if (oscillator.type !== newWave) {
                oscillator.type = newWave;
                timbreDisp.innerText = newWave.toUpperCase();
            }

            // Actualizar interfaz
            freqDisp.innerText = Math.round(frequency);
            volDisp.innerText = Math.round(volume * 100);
            document.body.style.backgroundColor = `hsl(${frequency / 5}, 70%, 15%)`;
        }

        // --- 3. Visualizador de Espectro ---
        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);

            if (!isPlaying || !analyser) {
                canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }

            analyser.getByteFrequencyData(dataArray);

            const WIDTH = canvas.width;
            const HEIGHT = canvas.height;

            // Limpiar canvas
            canvasCtx.fillStyle = 'rgb(34, 34, 34)';
            canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

            let barWidth = (WIDTH / analyser.frequencyBinCount) * 0.9;
            let barHeight;
            let x = 0;

            // Dibujar barras de frecuencia
            for(let i = 0; i < analyser.frequencyBinCount; i++) {
                barHeight = dataArray[i] / 2;

                // Color que reacciona a la frecuencia
                let hue = 180 + (i * 2.5);
                canvasCtx.fillStyle = 'hsl(' + hue + ', 100%, ' + (barHeight + 30) + '%)'; 
                canvasCtx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);

                x += barWidth + 1;
            }
        }

        // --- 4. Wake Lock (Para evitar que la pantalla se apague) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock: Activo');
                } catch (err) {
                    console.error('Wake Lock Error:', err.message);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock: Liberado');
            }
        }

        // --- 5. Toggle Play/Stop y Permisos ---
        async function togglePlay() {
            if (!audioCtx) initAudio();

            if (isPlaying) {
                // LGICA DE STOP
                releaseWakeLock(); 
                gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1); 
                audioCtx.suspend(); 
                isPlaying = false;

                toggleBtn.innerText = "ACTIVAR SONIDO Y SENSORES";
                toggleBtn.classList.remove('stop-color');
                statusText.innerText = "Detenido. Pulsa para reanudar.";
                document.body.style.backgroundColor = '#222';
            } else {
                // LGICA DE PLAY/RESUME
                
                // Pedir permisos y a帽adir listeners si es la primera vez
                if (!window.sensorListenerAttached) {
                   await requestPermissionsAndAttachListener();
                }
                
                // Si el permiso fue denegado, salimos
                if (!window.sensorListenerAttached) return;

                await requestWakeLock();
                
                audioCtx.resume().then(() => {
                    gainNode.gain.setTargetAtTime(0.01, audioCtx.currentTime, 0.1); 
                    isPlaying = true;

                    toggleBtn.innerText = "DETENER SONIDO";
                    toggleBtn.classList.add('stop-color');
                    statusText.innerText = "隆Sensores Activos! Mueve el m贸vil para cambiar Frecuencia (Inclinaci贸n), Volumen (Lateral) y Timbre (Rotaci贸n).";
                });
            }
        }
        
        async function requestPermissionsAndAttachListener() {
            window.addEventListener('deviceorientation', handleOrientation);
            window.sensorListenerAttached = true;

            // L贸gica para iOS 13+
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        alert("Permiso denegado para usar el giroscopio. El Theremin no funcionar谩.");
                        window.sensorListenerAttached = false;
                        return;
                    }
                } catch (e) {
                    console.error("Error al solicitar permisos:", e);
                    alert("Error cr铆tico con los sensores. Aseg煤rate de estar usando HTTPS.");
                    window.sensorListenerAttached = false;
                }
            }
        }

        // Evento del bot贸n principal
        toggleBtn.addEventListener('click', togglePlay);

        // Resiliencia del audio (Resume si el usuario vuelve a la pesta帽a)
        document.addEventListener('visibilitychange', () => {
            if (audioCtx && audioCtx.state === 'suspended' && document.visibilityState === 'visible' && isPlaying) {
                audioCtx.resume();
                requestWakeLock();
            } else if (audioCtx && document.visibilityState === 'hidden') {
                releaseWakeLock(); 
            }
        });
    </script>
</body>
</html>