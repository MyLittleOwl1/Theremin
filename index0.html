<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Theremin JavaScript V2</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #222;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            text-align: center;
            overflow: hidden; 
            transition: background-color 0.5s;
        }
        h1 { margin-bottom: 10px; }
        #status { font-size: 1.2rem; margin-bottom: 20px; color: #aaa; }
        
        button {
            padding: 15px 30px;
            font-size: 1.2rem;
            background-color: #00d2ff;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            color: #000;
            font-weight: bold;
            box-shadow: 0 0 15px #00d2ff;
            transition: transform 0.1s;
            margin-bottom: 10px;
        }
        button:active { transform: scale(0.95); }
        .stop-color { background-color: #ff3838; box-shadow: 0 0 15px #ff3838; }

        .data-display {
            margin-top: 30px;
            padding: 15px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            width: 80%;
        }
    </style>
</head>
<body>

    <h1> Theremin M贸vil</h1>
    <a href="index.html">
    <button style="margin-bottom: 5px; background-color: #28a745; box-shadow: 0 0 10px #28a745;">
        Ir a Versi贸n Avanzada
    </button>
</a>
    <p id="status">Pulsa el bot贸n para empezar a hacer m煤sica</p>
    
    <button id="toggleBtn">ACTIVAR SONIDO Y SENSORES</button>

    <div class="data-display">
        <p>Frecuencia (Beta): <span id="freqVal">0</span> Hz</p>
        <p>Volumen (Gamma): <span id="volVal">0</span> %</p>
    </div>

    <script>
        let audioCtx = null;
        let oscillator = null;
        let gainNode = null;
        let isPlaying = false;
        let wakeLock = null; // Para Wake Lock API

        const toggleBtn = document.getElementById('toggleBtn');
        const statusText = document.getElementById('status');
        const freqDisp = document.getElementById('freqVal');
        const volDisp = document.getElementById('volVal');

        // --- 1. Audio Setup ---
        function initAudio() {
            if (audioCtx) return; 

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioCtx = new AudioContext();

            oscillator = audioCtx.createOscillator();
            oscillator.type = 'sine';
            
            gainNode = audioCtx.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            // Iniciar suavemente
            gainNode.gain.value = 0;
            oscillator.start();
        }

        // --- 2. Sensor Handler ---
        function handleOrientation(event) {
            if (!isPlaying) return;

            // Beta (Eje de Frecuencia: 200Hz - 1000Hz)
            let beta = event.beta; 
            if (beta < 0) beta = 0; 
            if (beta > 90) beta = 90;

            const frequency = 200 + (beta * 8.8); // 800Hz de rango de modulaci贸n
            
            // Gamma (Eje de Volumen: 0 - 1)
            let gamma = event.gamma;
            let volume = (gamma + 45) / 90; // Mapea -45 a 0, +45 a 1
            
            if (volume < 0) volume = 0;
            if (volume > 1) volume = 1;

            // Aplicar cambios con un suavizado de 0.05s (evita clicks)
            oscillator.frequency.setTargetAtTime(frequency, audioCtx.currentTime, 0.05);
            gainNode.gain.setTargetAtTime(volume, audioCtx.currentTime, 0.05);

            // Actualizar interfaz
            freqDisp.innerText = Math.round(frequency);
            volDisp.innerText = Math.round(volume * 100);
            document.body.style.backgroundColor = `hsl(${frequency / 4}, 70%, 15%)`;
        }

        // --- 3. Wake Lock (Para evitar que la pantalla se apague) ---
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock: Activo');
                } catch (err) {
                    console.error('Wake Lock Error:', err.message);
                }
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake Lock: Liberado');
            }
        }

        // --- 4. Toggle Play/Stop ---
        async function togglePlay() {
            if (!audioCtx) initAudio();

            if (isPlaying) {
                // LGICA DE STOP
                releaseWakeLock(); // Liberar el bloqueo de pantalla
                gainNode.gain.setTargetAtTime(0, audioCtx.currentTime, 0.1); // Fundido de salida
                audioCtx.suspend(); 
                isPlaying = false;

                toggleBtn.innerText = "ACTIVAR SONIDO Y SENSORES";
                toggleBtn.classList.remove('stop-color');
                statusText.innerText = "Detenido. Pulsa para reanudar.";
                document.body.style.backgroundColor = '#222';
            } else {
                // LGICA DE PLAY/RESUME
                
                // Pedir permisos y a帽adir listeners si es la primera vez
                if (!window.sensorListenerAttached) {
                   await requestPermissionsAndAttachListener();
                }

                await requestWakeLock(); // Activar el bloqueo de pantalla
                
                audioCtx.resume().then(() => {
                    // Volumen inicial bajo despu茅s de reanudar
                    gainNode.gain.setTargetAtTime(0.01, audioCtx.currentTime, 0.1); 
                    isPlaying = true;

                    toggleBtn.innerText = "DETENER SONIDO";
                    toggleBtn.classList.add('stop-color');
                    statusText.innerText = "隆Sensores Activos! Mueve el m贸vil.";
                });
            }
        }
        
        // --- 5. Manejo de Permisos (iOS) ---
        async function requestPermissionsAndAttachListener() {
            // Este es el listener principal de sensores. Solo debe ser a帽adido una vez.
            window.addEventListener('deviceorientation', handleOrientation);
            window.sensorListenerAttached = true;

            // L贸gica para iOS 13+
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                try {
                    const permission = await DeviceOrientationEvent.requestPermission();
                    if (permission !== 'granted') {
                        alert("Permiso denegado. No se podr谩 usar el Theremin.");
                        window.sensorListenerAttached = false;
                        return;
                    }
                } catch (e) {
                    console.error("Error al solicitar permisos:", e);
                    alert("Error cr铆tico con los sensores.");
                }
            }
        }

        // Evento del bot贸n principal
        toggleBtn.addEventListener('click', togglePlay);

        // BONUS: Si el usuario vuelve a la aplicaci贸n (tras suspender), intenta reanudar el audio
        document.addEventListener('visibilitychange', () => {
            if (audioCtx && audioCtx.state === 'suspended' && document.visibilityState === 'visible' && isPlaying) {
                audioCtx.resume();
                requestWakeLock();
            } else if (audioCtx && document.visibilityState === 'hidden') {
                // Si la app pasa a segundo plano, liberamos el wake lock
                releaseWakeLock(); 
            }
        });
    </script>
</body>
</html>